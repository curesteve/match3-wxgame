# 待修复记录

## 1. iOS 真机宝石图片不显示（仅色块）— 已用合成 canvas 缓解

**现象**
- 微信开发者工具预览：棋盘格能正常显示 `images/gem_0.png`～`gem_4.png` 图片。
- iOS 手机预览：原先只显示色块棋盘格，不显示图片，且无报错。

**根因（真机调试证据）**
- 真机 readFileSync/readFile 读不到代码包；直连 `img.src = 'images/gem_N.png'` 与 `img.src = USER_DATA_PATH` 均不触发 onload/onerror，即 **iOS 上 createImage() + 本地/代码包路径加载图片不可靠**。

**已采用方案（生效证据 H5 J0）**
- 在微信环境下，**loadGemImages 入口处同步创建 5 个离屏 canvas**（32×32，每色一块），存入 `GEM_SYNTH_CANVASES[0..4]`。
- **drawGemImage** 中：若无可用 `GEM_IMAGES[colorIndex]`（即 `!ready`），则若存在 `GEM_SYNTH_CANVASES[colorIndex]`，用 `ctx.drawImage(synth, 0,0,32,32, dx,dy, s,s)` 绘制，**不经过 Image 对象**。
- 真机验证：H=5、J=0，合成 canvas 全部创建成功，棋盘以「由 canvas 绘制的纯色块」显示，不再依赖图片加载。

**当前逻辑概要（game.js）**
- 微信环境：先同步创建 5 个合成 canvas 并填入颜色；再尝试 readFileSync → readFile → getImageInfo+直连 → 可选 downloadFile（需配置 `GEM_IMAGES_BASE_URL`）。开发者工具下图片能加载则仍用 `GEM_IMAGES` 绘制；真机无图时用 `GEM_SYNTH_CANVASES` 绘制。

**若要在真机显示真实宝石图**
- 配置 CDN：设置 `GEM_IMAGES_BASE_URL` 并配置合法域名，由 `wx.downloadFile` 拉取 `gem_0.png`～`gem_4.png`，成功后 `img.src = tempFilePath`（若真机支持该 temp 路径的 Image 加载）。

**记录日期**：2025-02
