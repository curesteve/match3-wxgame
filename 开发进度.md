# 开发进度记录

## 2025-02-14（周六）

### 微信云开发持久化

**目标**：按《微信云开发持久化实施计划》接入微信云开发做存档与记录持久化，数据访问抽象便于后续迁自建库。

**已完成**

1. **环境与配置**
   - `game.json` 增加 `"cloud": true`。
   - `project.config.json` 增加 `cloudfunctionRoot: "cloudfunctions/"`，便于开发者工具识别云函数根目录与「当前环境」。
   - 云开发需在控制台创建环境，并在 `game.js` 中配置 `CLOUD_ENV`（环境 ID）。

2. **云函数（cloudfunctions/）**
   - **userEnsure**：确保用户存在，返回 `_id`，供后续进度与记录关联。
   - **progressGet**：按用户 ID 拉取云端存档。
   - **progressSave**：保存/覆盖用户存档到云端。
   - **recordSubmit**：提交单局游戏记录（过关/失败、分数等）。
   - 各云函数含 `index.js`、`config.json`、`package.json`（依赖 wx-server-sdk）。

3. **数据层与 game.js**
   - 抽象 `dataService`：`ensureUser`、`getProgress`、`saveProgress`、`submitRecord`，内部通过 `wx.cloud.callFunction` 调用云函数。
   - 启动流程：`main()` 中若存在 `wx.cloud` 且 `CLOUD_ENV` 非空则 `wx.cloud.init`；`loadSave()` 后异步执行 ensureUser → getProgress → 按 `updatedAt` 与本地存档合并 → 必要时 `saveSave` 与 `renderStart()`。
   - 过关/失败后：在 `saveSave(saveData)` 之后若 `currentUserId` 存在则异步调用 `saveProgress` 和 `submitRecord`；本地存档增加 `updatedAt` 字段。

4. **文档与版本控制**
   - `cloudfunctions/README.md`：开通云开发、建集合（users、game_save、game_records）、设置 CLOUD_ENV、上传部署等说明。
   - `.gitignore` 增加 `cloudfunctions/*/node_modules/`，避免提交云函数依赖。
   - 提交信息包含「微信云开发」相关说明；推送时如遇 non-fast-forward，需先 `git pull --rebase origin main` 再 `git push`。

**数据库集合建议权限**（在云开发控制台设置）

- `users`：仅创建者可写，可读按需。
- `game_save`：仅创建者可读写。
- `game_records`：仅创建者可写，可读按需（如做排行榜则需开放读权限）。

**备注**

- 云函数需在微信开发者工具中右键「cloudfunctions」选「当前环境」，再右键各云函数目录「上传并部署」；或于云开发控制台部署。
- 真机/工具需能访问网络且已开通云开发，否则仅走本地存档逻辑。
